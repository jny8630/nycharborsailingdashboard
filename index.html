<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#080e18">
<title>NYC Harbor Sailing</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚õµ</text></svg>">
<link rel="manifest" href="manifest.json">
<style>
:root{--bg:#080e18;--card:#131f2e;--card2:#0c1520;--bdr:#1a2d42;--bdr2:#2a4060;--txt:#e2e8f0;--dim:#8a9bb5;--mut:#5a7089;--fnt:#3a5068;--accent:#4fd1c5;--blue:#63b3ed;--orange:#ed8936;--green:#48bb78;--red:#f56565;--yellow:#ecc94b;--purple:#9f7aea;--mono:'SF Mono','Cascadia Code','JetBrains Mono','Fira Code',monospace}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,'SF Pro Display','Segoe UI',system-ui,sans-serif;background:linear-gradient(170deg,var(--bg),#0c1822 40%,var(--bg));color:var(--txt);max-width:440px;margin:0 auto;min-height:100vh;-webkit-font-smoothing:antialiased}
.hdr{background:linear-gradient(135deg,#0e1f30,#162d46);padding:18px 16px 14px;border-bottom:1px solid var(--bdr)}
.hdr-row{display:flex;justify-content:space-between;align-items:flex-start}
.hdr-label{font-size:10px;color:var(--accent);font-weight:700;letter-spacing:.12em;text-transform:uppercase}
.hdr-title{font-size:20px;font-weight:800;letter-spacing:-.03em;margin-top:2px}
.hdr-meta{font-size:10px;color:var(--fnt);margin-top:6px}
.btn{background:var(--bdr);border:1px solid var(--bdr2);border-radius:8px;color:var(--accent);padding:6px 12px;font-size:12px;cursor:pointer;font-weight:600}
.btn:active{opacity:.7}
.cnt{padding:10px 10px 30px}
.glance{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px}
.gl{background:linear-gradient(145deg,var(--card),var(--card2));border:1px solid var(--bdr);border-radius:12px;padding:12px 8px;text-align:center}
.gl-l{font-size:9px;color:var(--fnt);font-weight:700;letter-spacing:.1em}
.gl-v{font-size:26px;font-weight:800;font-family:var(--mono);margin-top:2px}
.gl-s{font-size:10px;color:var(--fnt);margin-top:2px}
.card{background:linear-gradient(145deg,var(--card),var(--card2));border:1px solid var(--bdr);border-radius:14px;margin-bottom:10px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,.3)}
.card-bar{height:2px}
.card-hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;cursor:pointer;color:var(--dim);user-select:none}
.card-t{display:flex;align-items:center;gap:8px;font-size:12px;font-weight:700;letter-spacing:.08em;text-transform:uppercase}
.card-body{padding:0 16px 16px}
.card-body.collapsed{display:none}
.wind-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:4px}
.bv{font-size:30px;font-weight:800;font-family:var(--mono);text-align:center}
.bv-l{font-size:10px;color:var(--fnt);text-align:center}
.status-pill{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;margin-bottom:6px}
.dot{display:inline-block;width:7px;height:7px;border-radius:50%;margin-right:7px;vertical-align:middle}
.tide-ev{display:flex;align-items:center;justify-content:space-between;padding:9px 12px;border-radius:10px;margin-bottom:3px;border:1px solid transparent}
.tide-ev.hl{background:#1a2d4250}
.tide-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px}
.tide-bar-wrap{margin:12px 0 6px;padding:0 4px}
.tide-bar-labels{display:flex;justify-content:space-between;font-size:10px;color:var(--fnt);margin-bottom:4px}
.tide-bar{height:6px;background:var(--card2);border-radius:3px;position:relative;overflow:visible}
.tide-bar-fill{height:100%;border-radius:3px}
.tide-bar-dot{position:absolute;top:-3px;width:12px;height:12px;border-radius:50%;border:2px solid var(--card2);transform:translateX(-50%)}
.upcoming{margin-top:6px;padding:8px 12px;background:rgba(12,21,32,.5);border-radius:8px}
.upcoming-l{font-size:10px;color:var(--fnt);margin-bottom:5px;font-weight:600;letter-spacing:.05em}
.upcoming-r{display:flex;justify-content:space-between;font-size:11px;color:var(--mut);padding:2px 0}
.tbtn{width:100%;margin-top:8px;padding:9px;background:transparent;border:1px solid var(--bdr);border-radius:8px;color:var(--accent);font-size:12px;cursor:pointer;font-weight:500}
.tbtn:active{opacity:.7}
.tbtn.active{background:var(--bdr)}
.wx-row{display:flex;align-items:center;gap:14px;margin-bottom:12px}
.wx-icon{font-size:40px}
.storm-bar{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-radius:8px;margin-bottom:8px;font-size:12px}
.fc-hdr,.fc-row{display:grid;grid-template-columns:56px 52px 42px 34px 34px 44px 36px;gap:2px;padding:4px 6px;font-size:12px;font-family:var(--mono);color:#a0b4c8;border-radius:4px}
.fc-hdr{font-size:9px;color:var(--fnt);font-weight:700;letter-spacing:.06em;text-transform:uppercase;border-bottom:1px solid var(--bdr);margin-bottom:3px;font-family:-apple-system,system-ui,sans-serif}
.fc-row.now{background:#1a2d4260;border-left:2px solid var(--accent)}
.links-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.link-c{display:block;padding:10px 12px;background:rgba(12,21,32,.5);border:1px solid var(--bdr);border-radius:8px;text-decoration:none;color:#c0ccda}
.link-c:active{opacity:.7}
.link-n{font-size:12px;font-weight:700;color:var(--accent)}
.link-d{font-size:10px;color:var(--fnt)}
.footer{text-align:center;padding:14px 0;font-size:10px;color:var(--fnt);border-top:1px solid var(--bdr);margin-top:6px}
.radar-links{display:flex;gap:6px;margin-top:8px}
.radar-links a{flex:1;text-align:center;padding:8px;background:var(--bdr);border:1px solid var(--bdr2);border-radius:6px;color:var(--accent);font-size:11px;text-decoration:none;font-weight:600}
canvas{display:block;width:100%;border-radius:8px}
.chart-wrap{margin-top:10px;background:var(--card2);border:1px solid var(--bdr);border-radius:10px;padding:10px 8px 6px;overflow:hidden}
.chart-title{font-size:10px;color:var(--fnt);font-weight:600;letter-spacing:.06em;margin-bottom:6px}
.chart-legend{display:flex;gap:14px;justify-content:center;margin-top:5px;font-size:10px;color:var(--fnt)}
.hidden{display:none}
@media(max-width:360px){.fc-hdr,.fc-row{grid-template-columns:48px 46px 38px 30px 30px 40px 32px;font-size:11px}}
</style>
</head>
<body>

<div class="hdr">
  <div class="hdr-row">
    <div><div class="hdr-label">‚õµ NYC Harbor</div><div class="hdr-title">Sailing Conditions</div></div>
    <button class="btn" onclick="loadAll()"><span id="ri">‚Üª</span> Refresh</button>
  </div>
  <div class="hdr-meta" id="meta">Loading‚Ä¶</div>
</div>

<div class="cnt">
  <div class="glance">
    <div class="gl"><div class="gl-l">WIND</div><div class="gl-v" id="gw" style="color:var(--green)">‚Äî</div><div class="gl-s" id="gwd"></div></div>
    <div class="gl"><div class="gl-l">TEMP</div><div class="gl-v" id="gt">‚Äî</div><div class="gl-s" id="gts"></div></div>
    <div class="gl"><div class="gl-l">TIDE</div><div id="gtd" style="font-size:13px;font-weight:800;color:var(--blue);margin-top:4px">‚Äî</div><div class="gl-s" id="gtn"></div></div>
  </div>

  <!-- WIND -->
  <div class="card"><div class="card-bar" style="background:linear-gradient(90deg,transparent,var(--green),transparent)"></div>
    <div class="card-hdr" onclick="toggle(this)"><div class="card-t"><span>üå¨Ô∏è</span> Wind ‚Äî Robbins Reef</div><span class="caret">‚ñº</span></div>
    <div class="card-body">
      <div class="wind-grid">
        <div><div class="bv" id="ws" style="color:var(--green)">‚Äî</div><div class="bv-l">kt sustained</div></div>
        <div><div class="bv" id="wg">‚Äî</div><div class="bv-l">kt gusts</div></div>
        <div><div class="bv" id="wdir" style="font-size:24px;margin-top:4px">‚Äî</div><div class="bv-l" id="wdeg"></div></div>
      </div>
      <!-- B&G Style Wind Plots -->
      <div class="chart-wrap">
        <div class="chart-title">WIND SPEED ‚Äî LAST 2 HOURS (B&G Style)</div>
        <canvas id="cvSpeed" height="120"></canvas>
        <div class="chart-legend"><span><span style="color:var(--green)">‚îÅ</span> Sustained</span><span><span style="color:var(--orange)">‚îÅ</span> Gusts</span><span style="color:var(--yellow);opacity:.5">‚îà Avg</span></div>
      </div>
      <div class="chart-wrap">
        <div class="chart-title">WIND DIRECTION ‚Äî LAST 2 HOURS</div>
        <canvas id="cvDir" height="100"></canvas>
        <div class="chart-legend"><span><span style="color:var(--blue)">‚îÅ</span> TWD</span><span style="color:var(--yellow);opacity:.5">‚îà Avg</span></div>
      </div>
      <div style="font-size:10px;color:var(--fnt);text-align:right;margin-top:6px" id="wtime"></div>
      <button class="tbtn" onclick="toggleEl('noaa-wrap');this.classList.toggle('active')" id="noaa-btn">View Full NOAA Station ‚Üó</button>
      <div id="noaa-wrap" class="hidden" style="margin-top:8px;border:1px solid var(--bdr);border-radius:8px;overflow:hidden">
        <iframe src="" id="noaa-iframe" style="width:100%;height:400px;border:none;background:#fff" title="NOAA Robbins Reef"></iframe>
      </div>
    </div>
  </div>

  <!-- TIDES -->
  <div class="card"><div class="card-bar" style="background:linear-gradient(90deg,transparent,var(--blue),transparent)"></div>
    <div class="card-hdr" onclick="toggle(this)"><div class="card-t"><span>üåä</span> Tides ‚Äî The Battery</div><span class="caret">‚ñº</span></div>
    <div class="card-body">
      <div id="tide-pill" class="status-pill" style="background:rgba(99,179,237,.08);border:1px solid rgba(99,179,237,.15)">
        <span class="dot" id="tdot" style="background:var(--blue);box-shadow:0 0 8px rgba(99,179,237,.5)"></span>
        <span id="tstat" style="font-size:14px;font-weight:700;color:var(--blue)">Loading‚Ä¶</span>
      </div>
      <div id="tbar"></div>
      <div id="tevents"></div>
      <div id="tupcoming" class="upcoming hidden"><div class="upcoming-l">UPCOMING</div><div id="tulist"></div></div>
      <button class="tbtn" onclick="toggleEl('tchart');this.classList.toggle('active')">Show Tide Chart (Brooklyn)</button>
      <div id="tchart" class="hidden" style="margin-top:8px;border:1px solid var(--bdr);border-radius:8px;overflow:hidden">
        <img src="https://www.tide-forecast.com/system/charts-png/Brooklyn-New-York/tides.png" style="width:100%;display:block;background:#fff" alt="Tide chart" onerror="this.outerHTML='<div style=padding:12px;font-size:12px;color:var(--mut);text-align:center>Chart unavailable ‚Äî <a href=https://www.tide-forecast.com/locations/Brooklyn-New-York/tides/latest target=_blank style=color:var(--accent)>view online</a></div>'">
      </div>
    </div>
  </div>

  <!-- WEATHER -->
  <div class="card"><div class="card-bar" style="background:linear-gradient(90deg,transparent,var(--yellow),transparent)"></div>
    <div class="card-hdr" onclick="toggle(this)"><div class="card-t"><span>üå°Ô∏è</span> Weather & Temperature</div><span class="caret">‚ñº</span></div>
    <div class="card-body">
      <div class="wx-row"><span class="wx-icon" id="wxi">üå§Ô∏è</span><div><div style="font-size:22px;font-weight:800" id="wxt">‚Äî</div><div style="font-size:12px;color:var(--mut)" id="wxd">Loading‚Ä¶</div></div></div>
      <div id="stormbar" class="storm-bar" style="border:1px solid rgba(72,187,120,.2)"><span style="color:var(--mut)">‚õà Thunderstorm Risk</span><span id="stormv" style="font-weight:700;color:var(--green)">‚Äî</span></div>
      <div id="wtemp" style="font-size:12px;color:var(--mut)"></div>
    </div>
  </div>

  <!-- FORECAST -->
  <div class="card"><div class="card-bar" style="background:linear-gradient(90deg,transparent,var(--purple),transparent)"></div>
    <div class="card-hdr" onclick="toggle(this)"><div class="card-t"><span>üìä</span> Wind Forecast ‚Äî HRRR (3km)</div><span class="caret">‚ñº</span></div>
    <div class="card-body">
      <div class="fc-hdr"><span>Time</span><span>Wind</span><span>Gust</span><span>Dir</span><span>Deg</span><span>Temp</span><span>Rain</span></div>
      <div id="fcrows"></div>
      <div style="font-size:9px;color:var(--fnt);margin-top:8px;text-align:right">Open-Meteo HRRR (3km) ¬∑ Updated hourly ¬∑ 18h range</div>
    </div>
  </div>

  <!-- RADAR -->
  <div class="card"><div class="card-bar" style="background:linear-gradient(90deg,transparent,var(--red),transparent)"></div>
    <div class="card-hdr" onclick="toggle(this)"><div class="card-t"><span>üì°</span> Radar ‚Äî NYC Harbor</div><span class="caret">‚ñº</span></div>
    <div class="card-body">
      <button id="radar-btn" class="tbtn" style="font-size:13px;font-weight:600" onclick="toggleRadar()">Show Live Radar Map (Windy)</button>
      <div id="radar-wrap" class="hidden" style="margin-top:10px">
        <div id="radar-ct"></div>
        <div style="font-size:10px;color:var(--fnt);margin-top:4px;text-align:center">Windy.com interactive radar ¬∑ pinch to zoom ¬∑ tap play</div>
        <div class="radar-links">
          <a href="https://www.windy.com/40.689/-74.045?radar,40.689,-74.045,10" target="_blank">Windy ‚Üó</a>
          <a href="https://www.accuweather.com/en/us/new-york/10007/weather-radar/349727" target="_blank">AccuWeather ‚Üó</a>
        </div>
      </div>
    </div>
  </div>

  <!-- LINKS -->
  <div class="card"><div class="card-bar" style="background:linear-gradient(90deg,transparent,var(--mut),transparent)"></div>
    <div class="card-hdr" onclick="toggle(this)"><div class="card-t"><span>üîó</span> Quick Links</div><span class="caret">‚ñ≤</span></div>
    <div class="card-body collapsed">
      <div class="links-grid">
        <a href="https://www.windy.com/40.689/-74.045?wind,40.689,-74.045,10" target="_blank" class="link-c"><div class="link-n">Windy HRRR</div><div class="link-d">Open in app</div></a>
        <a href="https://tidesandcurrents.noaa.gov/noaatidepredictions.html?id=8518750" target="_blank" class="link-c"><div class="link-n">NOAA Tides</div><div class="link-d">The Battery</div></a>
        <a href="https://www.tide-forecast.com/locations/Brooklyn-New-York/tides/latest" target="_blank" class="link-c"><div class="link-n">Tide Forecast</div><div class="link-d">Brooklyn</div></a>
        <a href="https://www.shallweswim.today/nyc" target="_blank" class="link-c"><div class="link-n">Shall We Swim</div><div class="link-d">NYC conditions</div></a>
        <a href="https://forecast.weather.gov/MapClick.php?lat=40.6892&lon=-74.0445&marine=1" target="_blank" class="link-c"><div class="link-n">NOAA Marine</div><div class="link-d">Harbor forecast</div></a>
        <a href="https://tidesandcurrents.noaa.gov/stationhome.html?id=8530973" target="_blank" class="link-c"><div class="link-n">Robbins Reef</div><div class="link-d">NOAA station</div></a>
      </div>
    </div>
  </div>

  <div class="footer">Data: NOAA CO-OPS ¬∑ Open-Meteo HRRR ¬∑ Windy<br>For planning only ‚Äî not for navigation ¬∑ Auto-refreshes 10 min</div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NYC HARBOR SAILING CONDITIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const ST={BAT:'8518750',ROB:'8530973'};
const NYC={lat:40.6892,lon:-74.0445};

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
const $=id=>document.getElementById(id);
const cardinal=d=>{if(d==null||isNaN(d))return'‚Äî';return['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'][Math.round(d/22.5)%16]};
const fmtT=d=>d?d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true,timeZone:'America/New_York'}):'‚Äî';
const fmtShort=d=>d?d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:false,timeZone:'America/New_York'}):'‚Äî';
const c2f=c=>(c*9/5+32).toFixed(0);
const mUntil=(f,n)=>{const m=(f-n)/6e4;if(m<1)return'now';if(m<60)return Math.round(m)+'m';const h=Math.floor(m/60),r=Math.round(m%60);return r>0?h+'h '+r+'m':h+'h'};
const wColor=k=>k>=25?'var(--red)':k>=18?'var(--orange)':k>=12?'var(--yellow)':k>=6?'var(--green)':'var(--dim)';
const fColor=f=>f==='flooding'?'var(--blue)':f==='ebbing'?'var(--orange)':'var(--dim)';
const wxI=c=>{if(c<=1)return'‚òÄÔ∏è';if(c<=3)return'‚õÖ';if(c<=48)return'üå´Ô∏è';if(c<=67)return'üåßÔ∏è';if(c>=95)return'‚õàÔ∏è';return'üå§Ô∏è'};
const wxD=c=>({0:'Clear',1:'Mostly Clear',2:'Partly Cloudy',3:'Overcast',45:'Fog',51:'Lt Drizzle',61:'Lt Rain',63:'Rain',65:'Heavy Rain',80:'Showers',81:'Mod Showers',82:'Hvy Showers',95:'Thunderstorm',96:'T-Storm+Hail'})[c]||'‚Äî';
const fmt2=d=>`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;

function parseNOAA(ts){
  if(!ts)return null;
  const p=new Intl.DateTimeFormat('en-US',{timeZone:'America/New_York',timeZoneName:'shortOffset'}).formatToParts(new Date());
  const tz=p.find(x=>x.type==='timeZoneName');
  let off='-05:00';
  if(tz){const m=tz.value.match(/GMT([+-]?\d+)/);if(m){const h=parseInt(m[1]);off=(h>=0?'+':'-')+String(Math.abs(h)).padStart(2,'0')+':00'}}
  const d=new Date(ts.replace(' ','T')+off);
  return isNaN(d)?null:d;
}

// ‚îÄ‚îÄ UI Toggles ‚îÄ‚îÄ
function toggle(hdr){const b=hdr.nextElementSibling;b.classList.toggle('collapsed');hdr.querySelector('.caret').textContent=b.classList.contains('collapsed')?'‚ñ≤':'‚ñº'}
function toggleEl(id){$(id).classList.toggle('hidden')}
let radarOn=false;
function toggleRadar(){
  radarOn=!radarOn;
  $('radar-wrap').classList.toggle('hidden',!radarOn);
  $('radar-btn').textContent=radarOn?'Hide Radar Map':'Show Live Radar Map (Windy)';
  if(radarOn&&!$('radar-ct').innerHTML){
    $('radar-ct').innerHTML='<iframe src="https://embed.windy.com/embed.html?type=map&location=coordinates&metricWind=kt&metricTemp=¬∞C&zoom=10&overlay=radar&product=radar&level=surface&lat=40.67&lon=-74.04" style="width:100%;height:340px;border:1px solid var(--bdr);border-radius:8px" frameborder="0" title="Radar"></iframe>';
  }
}

// ‚îÄ‚îÄ NOAA iframe lazy load ‚îÄ‚îÄ
document.getElementById('noaa-btn').addEventListener('click',function(){
  const iframe=$('noaa-iframe');
  if(!iframe.src||iframe.src==='')iframe.src='https://tidesandcurrents.noaa.gov/stationhome.html?id=8530973';
});

// ‚îÄ‚îÄ Fetchers ‚îÄ‚îÄ
async function getJ(u){const r=await fetch(u);if(!r.ok)throw new Error('HTTP '+r.status);return r.json()}

// Wind: get last 2 hours of 6-min data
async function fetchWindHistory(){
  const now=new Date();
  const start=new Date(now.getTime()-2*3600000);
  // NOAA wants date in YYYYMMDD HH:MM format
  const bd=fmt2(start)+' '+String(start.getHours()).padStart(2,'0')+':'+String(start.getMinutes()).padStart(2,'0');
  const u=`https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?begin_date=${encodeURIComponent(bd)}&range=3&station=${ST.ROB}&product=wind&units=english&time_zone=lst_ldt&format=json`;
  const d=await getJ(u);
  if(!d.data?.length)return null;
  return d.data.map(w=>({
    time:parseNOAA(w.t),
    speed:parseFloat(w.s),
    gusts:parseFloat(w.g),
    dir:parseFloat(w.d)
  })).filter(w=>w.time);
}

async function fetchWaterTemp(){
  const d=await getJ(`https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?date=latest&station=${ST.BAT}&product=water_temperature&datum=MLLW&units=english&time_zone=lst_ldt&format=json`);
  if(!d.data?.[0])return null;
  const f=parseFloat(d.data[0].v);return{f:f.toFixed(1),c:((f-32)*5/9).toFixed(1)};
}

async function fetchTides(){
  const now=new Date(),s=new Date(now),e=new Date(now);
  s.setDate(s.getDate()-1);e.setDate(e.getDate()+2);
  const d=await getJ(`https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?begin_date=${fmt2(s)}&end_date=${fmt2(e)}&station=${ST.BAT}&product=predictions&datum=MLLW&units=english&time_zone=lst_ldt&format=json&interval=hilo`);
  if(!d.predictions?.length)return null;
  const tides=d.predictions.filter(p=>p.type).map(p=>({time:parseNOAA(p.t),type:p.type.toUpperCase(),height:parseFloat(p.v).toFixed(1)})).filter(t=>t.time).sort((a,b)=>a.time-b.time);
  const past=tides.filter(t=>t.time<now),future=tides.filter(t=>t.time>=now);
  const prev=past.length?past[past.length-1]:null,next=future[0]||null,following=future[1]||null;
  let status='Unknown',flow='unknown';
  if(prev&&next){const mn=(next.time-now)/6e4,mp=(now-prev.time)/6e4;
    if(mn<=30){status=`Slack ‚Üí ${next.type==='H'?'High':'Low'}`;flow='slack'}
    else if(mp<=30){status=`Slack after ${prev.type==='H'?'High':'Low'}`;flow='slack'}
    else if(next.type==='H'){status='Flooding (Rising)';flow='flooding'}
    else{status='Ebbing (Falling)';flow='ebbing'}}
  return{prev,next,following,status,flow,allFuture:future.slice(0,6)};
}

async function fetchWeather(){
  // Current conditions + hourly (blended, for current wx code & temp)
  return await getJ(`https://api.open-meteo.com/v1/gfs?latitude=${NYC.lat}&longitude=${NYC.lon}&current=temperature_2m,apparent_temperature,weather_code,wind_speed_10m,wind_direction_10m,wind_gusts_10m&hourly=cape&wind_speed_unit=kn&temperature_unit=celsius&timezone=America/New_York&forecast_hours=3&past_hours=0`);
}

async function fetchHRRR(){
  // HRRR-only via minutely_15 (15-min resolution, HRRR source)
  return await getJ(`https://api.open-meteo.com/v1/gfs?latitude=${NYC.lat}&longitude=${NYC.lon}&minutely_15=temperature_2m,precipitation,wind_speed_10m,wind_direction_10m,wind_gusts_10m&wind_speed_unit=kn&temperature_unit=celsius&timezone=America/New_York&forecast_minutely_15=72&past_minutely_15=4`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// B&G STYLE CANVAS CHARTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function drawWindSpeedChart(canvas, data){
  if(!data||data.length<2)return;
  const ctx=canvas.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  const W=canvas.clientWidth, H=canvas.clientHeight;
  canvas.width=W*dpr; canvas.height=H*dpr;
  ctx.scale(dpr,dpr);

  // Compute rolling average (10-point ~1hr)
  const avgWindow=10;
  const avgs=data.map((_,i)=>{
    const start=Math.max(0,i-avgWindow+1);
    const slice=data.slice(start,i+1);
    return slice.reduce((s,d)=>s+d.speed,0)/slice.length;
  });

  const allVals=[...data.map(d=>d.speed),...data.map(d=>d.gusts),...avgs];
  const minV=Math.max(0,Math.min(...allVals)-2);
  const maxV=Math.max(...allVals)+2;
  const pad={t:8,b:20,l:32,r:8};
  const cw=W-pad.l-pad.r, ch=H-pad.t-pad.b;
  const xScale=i=>(i/(data.length-1))*cw+pad.l;
  const yScale=v=>pad.t+ch-(((v-minV)/(maxV-minV))*ch);

  // Grid
  ctx.strokeStyle='#1a2d42';ctx.lineWidth=0.5;
  const ySteps=4;
  for(let i=0;i<=ySteps;i++){
    const v=minV+(maxV-minV)*(i/ySteps);
    const y=yScale(v);
    ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();
    ctx.fillStyle='#3a5068';ctx.font='9px -apple-system,sans-serif';ctx.textAlign='right';
    ctx.fillText(v.toFixed(0),pad.l-4,y+3);
  }

  // Time labels
  ctx.fillStyle='#3a5068';ctx.font='9px -apple-system,sans-serif';ctx.textAlign='center';
  const labelEvery=Math.max(1,Math.floor(data.length/5));
  for(let i=0;i<data.length;i+=labelEvery){
    ctx.fillText(fmtShort(data[i].time),xScale(i),H-2);
  }

  // 12kt reference
  if(minV<12&&maxV>12){
    ctx.strokeStyle='#ecc94b35';ctx.lineWidth=1;ctx.setLineDash([4,4]);
    ctx.beginPath();ctx.moveTo(pad.l,yScale(12));ctx.lineTo(W-pad.r,yScale(12));ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle='#ecc94b50';ctx.font='8px -apple-system,sans-serif';ctx.textAlign='right';
    ctx.fillText('12kt',W-pad.r,yScale(12)-3);
  }

  // Gust area fill
  ctx.beginPath();ctx.moveTo(xScale(0),yScale(data[0].gusts));
  for(let i=1;i<data.length;i++)ctx.lineTo(xScale(i),yScale(data[i].gusts));
  ctx.lineTo(xScale(data.length-1),yScale(data[data.length-1].speed));
  for(let i=data.length-1;i>=0;i--)ctx.lineTo(xScale(i),yScale(data[i].speed));
  ctx.closePath();
  ctx.fillStyle='rgba(237,137,54,0.12)';ctx.fill();

  // Gust line
  ctx.beginPath();ctx.strokeStyle='#ed893660';ctx.lineWidth=1;
  for(let i=0;i<data.length;i++){const x=xScale(i),y=yScale(data[i].gusts);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)}
  ctx.stroke();

  // Speed filled area
  ctx.beginPath();ctx.moveTo(xScale(0),yScale(minV));
  for(let i=0;i<data.length;i++)ctx.lineTo(xScale(i),yScale(data[i].speed));
  ctx.lineTo(xScale(data.length-1),yScale(minV));ctx.closePath();
  const grad=ctx.createLinearGradient(0,pad.t,0,H-pad.b);
  grad.addColorStop(0,'rgba(72,187,120,0.3)');grad.addColorStop(1,'rgba(72,187,120,0.02)');
  ctx.fillStyle=grad;ctx.fill();

  // Speed line
  ctx.beginPath();ctx.strokeStyle='#48bb78';ctx.lineWidth=2;
  for(let i=0;i<data.length;i++){const x=xScale(i),y=yScale(data[i].speed);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)}
  ctx.stroke();

  // Average line (dashed yellow)
  ctx.beginPath();ctx.strokeStyle='#ecc94b60';ctx.lineWidth=1.5;ctx.setLineDash([6,3]);
  for(let i=0;i<avgs.length;i++){const x=xScale(i),y=yScale(avgs[i]);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)}
  ctx.stroke();ctx.setLineDash([]);

  // Current value marker
  const lastI=data.length-1;
  ctx.beginPath();ctx.arc(xScale(lastI),yScale(data[lastI].speed),4,0,Math.PI*2);
  ctx.fillStyle='#48bb78';ctx.fill();
  ctx.strokeStyle='#0c1520';ctx.lineWidth=2;ctx.stroke();
}

function drawWindDirChart(canvas, data){
  if(!data||data.length<2)return;
  const ctx=canvas.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  const W=canvas.clientWidth, H=canvas.clientHeight;
  canvas.width=W*dpr; canvas.height=H*dpr;
  ctx.scale(dpr,dpr);

  // Unwrap direction to handle 360/0 crossings
  const dirs=[data[0].dir];
  for(let i=1;i<data.length;i++){
    let d=data[i].dir,prev=dirs[i-1];
    while(d-prev>180)d-=360;
    while(prev-d>180)d+=360;
    dirs.push(d);
  }

  // Rolling average
  const avgW=10;
  const avgs=dirs.map((_,i)=>{
    const start=Math.max(0,i-avgW+1);
    const sl=dirs.slice(start,i+1);
    return sl.reduce((s,v)=>s+v,0)/sl.length;
  });

  const allD=[...dirs,...avgs];
  const minD=Math.min(...allD)-5, maxD=Math.max(...allD)+5;
  const pad={t:8,b:20,l:32,r:8};
  const cw=W-pad.l-pad.r, ch=H-pad.t-pad.b;
  const xScale=i=>(i/(data.length-1))*cw+pad.l;
  const yScale=v=>pad.t+ch-(((v-minD)/(maxD-minD))*ch);

  // Grid
  ctx.strokeStyle='#1a2d42';ctx.lineWidth=0.5;
  const range=maxD-minD;
  const step=range>60?20:range>30?10:5;
  for(let v=Math.ceil(minD/step)*step;v<=maxD;v+=step){
    const y=yScale(v);
    ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();
    // Normalize label to 0-360
    let label=((v%360)+360)%360;
    ctx.fillStyle='#3a5068';ctx.font='9px -apple-system,sans-serif';ctx.textAlign='right';
    ctx.fillText(label.toFixed(0)+'¬∞',pad.l-4,y+3);
  }

  // Time labels
  ctx.fillStyle='#3a5068';ctx.font='9px -apple-system,sans-serif';ctx.textAlign='center';
  const le=Math.max(1,Math.floor(data.length/5));
  for(let i=0;i<data.length;i+=le)ctx.fillText(fmtShort(data[i].time),xScale(i),H-2);

  // Average line
  ctx.beginPath();ctx.strokeStyle='#ecc94b60';ctx.lineWidth=1.5;ctx.setLineDash([6,3]);
  for(let i=0;i<avgs.length;i++){const x=xScale(i),y=yScale(avgs[i]);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)}
  ctx.stroke();ctx.setLineDash([]);

  // Direction shaded area between actual and average
  ctx.beginPath();
  for(let i=0;i<dirs.length;i++){const x=xScale(i),y=yScale(dirs[i]);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)}
  for(let i=dirs.length-1;i>=0;i--){const x=xScale(i),y=yScale(avgs[i]);ctx.lineTo(x,y)}
  ctx.closePath();ctx.fillStyle='rgba(99,179,237,0.1)';ctx.fill();

  // Direction line
  ctx.beginPath();ctx.strokeStyle='#63b3ed';ctx.lineWidth=2;
  for(let i=0;i<dirs.length;i++){const x=xScale(i),y=yScale(dirs[i]);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)}
  ctx.stroke();

  // Current value marker
  const li=dirs.length-1;
  ctx.beginPath();ctx.arc(xScale(li),yScale(dirs[li]),4,0,Math.PI*2);
  ctx.fillStyle='#63b3ed';ctx.fill();
  ctx.strokeStyle='#0c1520';ctx.lineWidth=2;ctx.stroke();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDERERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderWind(history){
  if(!history?.length)return;
  const last=history[history.length-1];
  const s=last.speed.toFixed(1),g=last.gusts.toFixed(1);
  $('ws').textContent=s;$('ws').style.color=wColor(last.speed);
  $('wg').textContent=g<0.1?'‚Äî':g;
  $('wdir').innerHTML=`<span style="display:inline-block;transform:rotate(${last.dir}deg);margin-right:4px">‚Üì</span>${cardinal(last.dir)}`;
  $('wdeg').textContent=isNaN(last.dir)?'':'('+last.dir.toFixed(0)+'¬∞)';
  $('wtime').textContent=last.time?'NOAA 6-min data ¬∑ Latest: '+fmtT(last.time):'';
  $('gw').textContent=s;$('gw').style.color=wColor(last.speed);
  $('gwd').textContent='kt '+cardinal(last.dir);

  // Draw B&G charts
  drawWindSpeedChart($('cvSpeed'),history);
  drawWindDirChart($('cvDir'),history);
}

function renderTides(t){
  if(!t)return;
  const fc=fColor(t.flow),now=new Date();
  $('tstat').textContent=t.status;$('tstat').style.color=fc;
  $('tdot').style.background=fc;$('tdot').style.boxShadow=`0 0 8px ${fc}`;
  $('gtd').textContent=t.status;$('gtd').style.color=fc;
  $('gtn').textContent=t.next?'Next: '+fmtT(t.next.time):'';

  // Progress bar
  if(t.prev&&t.next){
    const pct=Math.max(0,Math.min(100,((now-t.prev.time)/(t.next.time-t.prev.time))*100));
    $('tbar').innerHTML=`<div class="tide-bar-wrap"><div class="tide-bar-labels"><span>${t.prev.type==='H'?'‚ñ≤ HIGH':'‚ñº LOW'} ${fmtT(t.prev.time)}</span><span>${t.next.type==='H'?'‚ñ≤ HIGH':'‚ñº LOW'} ${fmtT(t.next.time)}</span></div><div class="tide-bar"><div class="tide-bar-fill" style="width:${pct}%;background:linear-gradient(90deg,${fc}70,${fc})"></div><div class="tide-bar-dot" style="left:${pct}%;background:${fc};box-shadow:0 0 10px ${fc}80"></div></div><div style="text-align:center;font-size:10px;color:var(--fnt);margin-top:5px">${mUntil(t.next.time,now)} until ${t.next.type==='H'?'high':'low'} tide</div></div>`;
  }

  // Events
  let h='';
  [{l:'Previous',t:t.prev,hl:0},{l:'Next',t:t.next,hl:1},{l:'Following',t:t.following,hl:0}].forEach(({l,t:td,hl})=>{
    if(!td){h+=`<div class="tide-ev" style="opacity:.4;font-size:13px">${l}: ‚Äî</div>`;return}
    const isH=td.type==='H',c=isH?'var(--blue)':'var(--orange)';
    h+=`<div class="tide-ev${hl?' hl':''}" ${hl?`style="border-color:${c}30"`:''}><div style="display:flex;align-items:center;gap:10px"><div class="tide-icon" style="background:${c}18">${isH?'‚¨Ü':'‚¨á'}</div><div><div style="font-size:13px;font-weight:700;color:${c}">${isH?'High':'Low'} Tide</div><div style="font-size:10px;color:var(--fnt)">${l}</div></div></div><div style="text-align:right"><div style="font-size:16px;font-weight:800;color:var(--txt);font-family:var(--mono)">${fmtT(td.time)}</div><div style="font-size:10px;color:var(--fnt)">${td.height} ft${hl&&td.time>now?' ¬∑ in '+mUntil(td.time,now):''}</div></div></div>`;
  });
  $('tevents').innerHTML=h;

  if(t.allFuture?.length>2){
    $('tupcoming').classList.remove('hidden');
    $('tulist').innerHTML=t.allFuture.slice(2).map(u=>`<div class="upcoming-r"><span>${u.type==='H'?'‚Üë High':'‚Üì Low'}</span><span style="font-family:var(--mono)">${fmtT(u.time)} (${u.height} ft)</span></div>`).join('');
  }
}

function renderWeather(wx,wt){
  if(!wx?.current)return;
  const c=wx.current,tc=c.temperature_2m,tf=c2f(tc),code=c.weather_code;
  $('wxi').textContent=wxI(code);
  $('wxt').textContent=tc.toFixed(1)+'¬∞C / '+tf+'¬∞F';
  $('wxd').textContent=wxD(code)+' ¬∑ Feels '+c.apparent_temperature.toFixed(0)+'¬∞C';
  $('gt').textContent=tc.toFixed(0)+'¬∞';$('gts').textContent=tf+'¬∞F '+wxI(code);

  const cape=wx.hourly?.cape?.[0]||0;
  let risk='None',sc='var(--green)';
  if(cape>2000){risk='HIGH';sc='var(--red)'}else if(cape>1000){risk='Moderate';sc='var(--orange)'}else if(cape>500){risk='Low';sc='var(--yellow)'}
  $('stormv').textContent=risk+(cape?' (CAPE: '+cape.toFixed(0)+')':'');$('stormv').style.color=sc;

  if(wt)$('wtemp').textContent='üåä Water: '+wt.f+'¬∞F / '+wt.c+'¬∞C';
}

function renderForecast(hrrr){
  if(!hrrr?.minutely_15?.time)return;
  const m=hrrr.minutely_15,now=Date.now();
  let rows='',count=0;
  // Show every 4th entry (= hourly from 15-min data)
  for(let i=0;i<m.time.length;i+=4){
    const t=new Date(m.time[i]),diff=(t-now)/36e5;
    if(diff<-0.5)continue;
    if(count>=10)break;
    const isNow=diff>=-0.25&&diff<0.75;
    const wind=m.wind_speed_10m?.[i],gust=m.wind_gusts_10m?.[i],dir=m.wind_direction_10m?.[i],temp=m.temperature_2m?.[i];
    const wk=wind!=null?wind.toFixed(0):'‚Äî';
    const gk=gust!=null?gust.toFixed(0):'‚Äî';
    const dk=dir!=null?dir.toFixed(0):'‚Äî';
    const tk=temp!=null?temp.toFixed(0):'‚Äî';
    const pr=m.precipitation?.[i];
    const precip=pr!=null&&pr>0?'üíß':'¬∑';
    rows+=`<div class="fc-row${isNow?' now':''}"><span style="font-weight:${isNow?700:400};color:${isNow?'var(--accent)':'var(--fnt)'}; font-size:11px">${fmtT(t)}</span><span style="color:${wColor(wind)};font-weight:700">${wk} kt</span><span style="color:var(--mut)">G${gk}</span><span>${cardinal(dir)}</span><span style="color:var(--mut)">${dk}¬∞</span><span>${tk}¬∞</span><span style="text-align:center">${precip}</span></div>`;
    count++;
  }
  $('fcrows').innerHTML=rows||'<div style="padding:8px;color:var(--mut)">No HRRR data available</div>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAIN LOADER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function loadAll(){
  $('ri').textContent='‚ü≥';
  try{
    const[wh,wt,td,wx,hr]=await Promise.allSettled([
      fetchWindHistory(),fetchWaterTemp(),fetchTides(),fetchWeather(),fetchHRRR()
    ]);
    if(wh.status==='fulfilled')renderWind(wh.value);
    if(td.status==='fulfilled')renderTides(td.value);
    if(wx.status==='fulfilled')renderWeather(wx.value,wt.status==='fulfilled'?wt.value:null);
    if(hr.status==='fulfilled')renderForecast(hr.value);

    const now=new Date();
    $('meta').textContent='Updated '+fmtT(now)+' ¬∑ '+now.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',timeZone:'America/New_York'});
  }catch(e){console.error(e)}
  $('ri').textContent='‚Üª';
}

// Handle canvas resize
window.addEventListener('resize',()=>{
  // Redraw charts if we have data cached
  if(window._windHistory){
    drawWindSpeedChart($('cvSpeed'),window._windHistory);
    drawWindDirChart($('cvDir'),window._windHistory);
  }
});

// Patch fetchWindHistory to cache data for resize
const _origFetchWind=fetchWindHistory;
fetchWindHistory=async function(){
  const d=await _origFetchWind();
  window._windHistory=d;
  return d;
};

loadAll();
setInterval(loadAll,600000);
</script>
</body>
</html>
